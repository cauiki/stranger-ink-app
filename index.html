<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0b141a">
    <title>Stranger Ink - A Casa Ink Hub</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500&family=Bebas+Neue&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="Logo.png">

    <style>
        :root {
            --bg-app: #0b141a; --bg-header: #202c33; --bg-input: #202c33;
            --bubble-in: #202c33; --bubble-out: #005c4b; --accent: #00a884;
            --text-main: #e9edef; --text-sec: #8696a0; --neon-red: #ff0033;
            --arcade-font: 'Press Start 2P', cursive;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Heebo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: #000; height: 100dvh; width: 100vw; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        #app-frame { width: 100%; max-width: 500px; height: 100%; background-color: var(--bg-app); position: relative; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); }

        .full-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        
        .logo-container { width: 80%; max-width: 400px; margin-bottom: 40px; }
        .logo-container img { width: 100%; display: block; filter: drop-shadow(0 0 15px var(--neon-red)); }

        .btn-start {
            background: var(--neon-red); color: #000; border: none; padding: 20px 50px;
            font-family: 'Bebas Neue', cursive; font-size: 3rem; letter-spacing: 2px;
            cursor: pointer; border-radius: 10px; box-shadow: 0 0 25px var(--neon-red);
            animation: blink 0.5s infinite alternate; text-transform: uppercase;
        }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.7; } }

        .arcade-input {
            background: transparent; border: 3px solid var(--neon-red); color: var(--neon-red);
            font-family: var(--arcade-font); font-size: 1.2rem; padding: 15px; text-align: center;
            width: 80%; text-transform: uppercase; margin: 20px 0; outline: none;
            box-shadow: 0 0 10px var(--neon-red);
        }

        .ranking-list {
            width: 90%; background: #111; border: 2px solid var(--accent); padding: 15px;
            margin: 20px 0; max-height: 40%; overflow-y: auto; font-family: var(--arcade-font);
        }
        .rank-row { display: flex; justify-content: space-between; color: #fff; font-size: 0.7rem; margin-bottom: 10px; border-bottom: 1px dashed #333; padding-bottom: 5px; }
        .rank-1 { color: #ffd700; }

        header { background: var(--bg-header); height: 65px; padding: 0 15px; display: flex; align-items: center; z-index: 10; flex-shrink: 0; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin: 0 12px; }
        .info { flex: 1; color: var(--text-main); } .name { font-weight: 600; } .status { font-size: 0.8rem; color: var(--accent); }
        .icons { display: flex; gap: 20px; color: #fff; font-size: 1.2rem; }

        .stats-bar {
            background: rgba(0,0,0,0.8); color: #fff; padding: 8px 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--neon-red); flex-shrink: 0; font-family: var(--arcade-font); font-size: 0.7rem;
        }
        .timer-warning { color: var(--neon-red); animation: blink 0.3s infinite; }

        #chat-container { flex: 1; background: url('Fundo do WhatsApp.jpg') repeat; background-size: cover; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 10px; color: #fff; font-size: 0.95rem; position: relative; word-wrap: break-word; }
        .incoming { align-self: flex-start; background: var(--bubble-in); border-top-left-radius: 0; }
        .outgoing { align-self: flex-end; background: var(--bubble-out); border-top-right-radius: 0; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; }
        .msg-meta { font-size: 0.7rem; color: rgba(255,255,255,0.6); text-align: right; margin-top: 4px; }

        #input-area { background: var(--bg-header); padding: 10px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .input-wrapper { flex: 1; background: #2a3942; border-radius: 24px; display: flex; align-items: center; padding: 8px 15px; }
        #message-input { flex: 1; background: transparent; border: none; color: white; font-size: 1rem; outline: none; }
        .mic-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); border: none; color: white; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; cursor: pointer; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="app-frame">
        <div id="start-screen" class="full-screen">
            <div class="logo-container"><img src="Logo.png" alt="Logo"></div>
            <button class="btn-start" onclick="irParaNome()">COMEÃ‡AR</button>
        </div>
        <div id="name-screen" class="full-screen hidden">
            <h2 style="color:var(--neon-red); font-family:var(--arcade-font)">QUEM Ã‰ VOCÃŠ?</h2>
            <input type="text" id="player-name" class="arcade-input" maxlength="10" placeholder="SEU NOME">
            <button class="btn-start" style="font-size:1.5rem; padding:15px 40px" onclick="iniciarJogo()">JOGAR</button>
        </div>
        <div id="result-screen" class="full-screen hidden">
            <h1 id="res-title" style="color:#fff; font-family:'Bebas Neue'; font-size:3rem;"></h1>
            <p id="res-msg" style="color:#ccc; margin-bottom:20px"></p>
            <div class="ranking-box" id="ranking-list">Carregando...</div>
            <button onclick="proximoCliente()" class="btn-start" style="font-size:1.2rem; padding:15px; background:var(--accent); animation:none; margin-top:20px">PRÃ“XIMO</button>
        </div>

        <header id="app-header" class="hidden">
            <i class="fas fa-arrow-left back-icon" style="color:#fff; font-size:1.2rem; margin-right:10px; cursor:pointer" onclick="location.reload()"></i>
            <div class="profile-area">
                <img id="char-img" class="avatar" src="">
                <div class="info"><div class="name" id="char-name">...</div><div class="status" id="char-status">online</div></div>
            </div>
            <div class="icons"><i class="fas fa-video"></i><i class="fas fa-phone"></i><i class="fas fa-ellipsis-v"></i></div>
        </header>
        <div id="stats-bar" class="stats-bar hidden">
            <div>VIBE: <span id="vibe-val" style="color:#25d366">100%</span></div>
            <div id="timer-box">ATENDER: 04:00</div>
        </div>
        <div id="chat-container" class="hidden">
             <div class="msg system" style="text-align:center; color: gold; font-size: 0.8rem; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 10px; margin: 10px auto; width: 90%;">ðŸ”’ As mensagens sÃ£o protegidas de ponta a ponta.</div>
        </div>
        <div id="input-area" class="hidden">
            <div class="input-wrapper">
                <i class="far fa-smile" style="color:#8696a0; margin-right:10px"></i>
                <input type="text" id="message-input" placeholder="Mensagem" autocomplete="off">
                <label for="img-up"><i class="fas fa-paperclip" style="color:#8696a0; margin-left:10px; cursor:pointer"></i></label>
                <input type="file" id="img-up" accept="image/*" style="display:none" onchange="enviarImagem(this)">
                <i class="fas fa-camera" style="color:#8696a0; margin-left:10px"></i>
            </div>
            <button class="mic-btn" id="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- LÃ“GICA -->
    <script>
        const PERSONAGENS = [
            { id: "billy", nome: "Billy Hargrove", img: "Billy Hargrove normal.jpg", win: "Billy Hargrove vitoria.jpg", lose: "Billy Hargrove derrota.jpg", prompt: "VocÃª Ã© Billy Hargrove. Agressivo, rude. Odeia esperar. Se a vendedora for firme, respeite. Se for mole, ataque." },
            { id: "eleven", nome: "Eleven", img: "Eleven Normal.jpg", win: "Eleven Vitoria.jpg", lose: "Eleven brava.jpg", prompt: "VocÃª Ã© Eleven. Fala pouco. Desconfiada. Valoriza amigos." },
            { id: "dustin", nome: "Dustin", img: "Dustin Normal.jpg", win: "Dustin vitoria.jpg", lose: "Dustin Derrota.jpg", prompt: "VocÃª Ã© Dustin. Nerd, fala muito, usa gÃ­rias de RPG." },
            { id: "hopper", nome: "Jim Hopper", img: "Jim Hopper Normal.jpg", win: "Jim Hopper Vitoria.jpg", lose: "Jim Hopper derrota.jpg", prompt: "VocÃª Ã© Hopper. Rabugento, impaciente, autoritÃ¡rio." },
            { id: "eddie", nome: "Eddie Munson", img: "Eddie Munson Normal.jpg", win: "Eddie Munson Vitoria.jpg", lose: "Eddie Munson Derrota.jpg", prompt: "VocÃª Ã© Eddie. Metaleiro, sem grana, tenta troca." },
             { id: "max", nome: "Max Mayfield", img: "Max Mayfield Normal.jpg", win: "Max Mayfield Vitoria.jpg", lose: "Max Mayfield Derrota.jpg", prompt: "VocÃª Ã© Max. SarcÃ¡stica, fechada, desconfiada." },
            { id: "steve", nome: "Steve Harrington", img: "Steve Harrington normal.jpg", win: "Steve Harrington Vitoria.jpg", lose: "Steve Harrington derrota.jpg", prompt: "VocÃª Ã© Steve. Vaidoso com cabelo, quer algo 'cool'." },
            { id: "nancy", nome: "Nancy Wheeler", img: "Nancy Wheeler normal.jpg", win: "Nancy Wheeler Vitoria.jpg", lose: "Nancy Wheeler Derrota.jpg", prompt: "VocÃª Ã© Nancy. Investigativa, exigente com detalhes." },
            { id: "joyce", nome: "Joyce Byers", img: "Joyce Byers normal.jpg", win: "Joyce Byers Vitoria.jpg", lose: "Joyce Byers Derrota.jpg", prompt: "VocÃª Ã© Joyce. Muito ansiosa, preocupada, fala muito." },
            { id: "lucas", nome: "Lucas Sinclair", img: "Lucas Sinclair Normal.jpg", win: "Lucas Sinclair Vitoria.jpg", lose: "Lucas Sinclair derrota.jpg", prompt: "VocÃª Ã© Lucas. CÃ©tico, racional, quer preÃ§o justo." }
        ];

        let state = { vibe: 100, charIndex: 0, history: [], playerName: "PLAYER", score: 0 };
        let timer = { int: null, val: 0 };

        function irParaNome() { document.getElementById('start-screen').classList.add('hidden'); document.getElementById('name-screen').classList.remove('hidden'); }
        
        function iniciarJogo() {
            const nome = document.getElementById('player-name').value.trim();
            if(!nome) return alert("Digite seu nome!");
            state.playerName = nome.toUpperCase();
            document.getElementById('name-screen').classList.add('hidden');
            mostrarInterface();
            carregarPersonagem();
        }

        function mostrarInterface() {
            document.getElementById('app-header').classList.remove('hidden');
            document.getElementById('stats-bar').classList.remove('hidden');
            document.getElementById('chat-container').classList.remove('hidden');
            document.getElementById('input-area').classList.remove('hidden');
        }

        function carregarPersonagem() {
            const char = PERSONAGENS[state.charIndex];
            document.getElementById('char-name').innerText = char.nome;
            document.getElementById('char-img').src = char.img;
            
            state.history = [];
            state.vibe = 100;
            document.getElementById('vibe-val').innerText = "100%";
            
            const chat = document.getElementById('chat-container');
            chat.innerHTML = '<div class="msg system" style="text-align:center; font-size:0.7rem; color:gold; background:rgba(0,0,0,0.5); padding:5px; border-radius:10px; width:90%; margin:10px auto">ðŸ”’ Mensagens protegidas</div>';

            enviarParaIA("INICIO");
            startTimer(240, "ATENDER");
        }

        function startTimer(sec, label) {
            clearInterval(timer.int);
            timer.val = sec;
            const el = document.getElementById('timer-box');
            timer.int = setInterval(() => {
                timer.val--;
                const m = Math.floor(timer.val/60).toString().padStart(2,'0');
                const s = (timer.val%60).toString().padStart(2,'0');
                el.innerText = `${label}: ${m}:${s}`;
                el.style.color = timer.val < 60 ? "var(--neon-red)" : "#fff";
                if(timer.val <= 0) { clearInterval(timer.int); endGame(false); }
            }, 1000);
        }

        async function enviarParaIA(text, image=null) {
            document.getElementById('char-status').innerText = "digitando...";
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: text, characterPrompt: PERSONAGENS[state.charIndex].prompt, history: state.history, image })
                });
                
                if (!response.ok) throw new Error(response.statusText);
                
                const data = await response.json();
                
                document.getElementById('char-status').innerText = "online";
                let reply = data.reply.replace(/\[.*?\]/g, "").trim();
                addMsg(reply, 'incoming');
                
                if (text !== "INICIO") {
                     state.history.push({role: "user", parts: [{text}]}, {role: "model", parts: [{text: reply}]});
                     state.vibe += data.vibe_change;
                     if(state.vibe > 100) state.vibe = 100;
                     document.getElementById('vibe-val').innerText = state.vibe + "%";
                } else {
                     state.history.push({role: "model", parts: [{text: reply}]});
                }

                if(data.status === 'won') endGame(true);
                if(data.status === 'lost' || state.vibe <= 0) endGame(false);
            } catch(e) { 
                console.error(e); 
                addMsg(`Erro: ${e.message}. Verifique chave API na Vercel.`, 'system'); 
                document.getElementById('char-status').innerText = "online";
            }
        }

        function addMsg(html, type) {
            const div = document.createElement('div'); div.className = `msg ${type}`;
            const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            div.innerHTML = `${html} <div class="msg-meta">${time} ${type==='outgoing'?'<i class="fas fa-check-double" style="color:#53bdeb"></i>':''}</div>`;
            const chat = document.getElementById('chat-container');
            chat.appendChild(div); chat.scrollTop = chat.scrollHeight;
        }

        const input = document.getElementById('message-input'), btn = document.getElementById('send-btn');
        btn.addEventListener('click', () => {
            const val = input.value.trim();
            if(!val) return;
            if(document.getElementById('timer-box').innerText.includes("ATENDER")) startTimer(20*60, "FECHAR VENDA");
            addMsg(val, 'outgoing'); input.value = ''; enviarParaIA(val);
        });
        input.addEventListener('keypress', e => { if(e.key==='Enter') btn.click() });
        
        window.enviarImagem = (inp) => {
            const file = inp.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = e => {
                addMsg(`<img src="${e.target.result}">`, 'outgoing');
                enviarParaIA("Analise esta imagem.", e.target.result.split(',')[1]);
            };
            r.readAsDataURL(file);
        };

        async function endGame(win) {
            clearInterval(timer.int);
            const char = PERSONAGENS[state.charIndex];
            const points = win ? (state.vibe * 10) + timer.val : 0;
            state.score += points;

            // Ranking Local (Se nÃ£o tiver Firebase)
            let r = JSON.parse(localStorage.getItem('rank') || "[]");
            r.push({nome: state.playerName, pontos: state.score});
            localStorage.setItem('rank', JSON.stringify(r));

            setTimeout(() => {
                const s = document.getElementById('result-screen');
                s.classList.remove('hidden');
                document.getElementById('app-header').classList.add('hidden');
                document.getElementById('chat-container').classList.add('hidden');
                document.getElementById('input-area').classList.add('hidden');
                document.getElementById('stats-bar').classList.add('hidden');

                document.getElementById('result-img').src = win ? char.win : char.lose;
                document.getElementById('res-title').innerText = win ? "VENDA FECHADA!" : "PERDEU!";
                document.getElementById('res-msg').innerText = `Pontos: ${points}`;
                carregarRanking();
            }, 1500);
        }

        function carregarRanking() {
            const list = document.getElementById('ranking-list');
            let d = JSON.parse(localStorage.getItem('rank') || "[]").sort((a,b)=>b.pontos-a.pontos).slice(0,5);
            list.innerHTML = d.map((x,i) => `<div class="rank-row ${i===0?'rank-1':''}"><span class="r-name">${i+1}. ${x.nome}</span><span>${x.pontos}</span></div>`).join('');
        }

        window.proximoCliente = () => {
            document.getElementById('result-screen').classList.add('hidden');
            state.charIndex++;
            if(state.charIndex >= PERSONAGENS.length) state.charIndex = 0;
            mostrarInterface(); carregarPersonagem();
        }
    </script>
</body>
</html>